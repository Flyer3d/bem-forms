# form blocks draft

## Common API

### Блок `form` *extends `BEM`*

Базовый функционал формы — получить объект со значениями, заполнить другими значениями, подписаться 

##### Методы экземпляра

- `{Object} form.getVal()` - возвращает данные полей (или контролов) в нормализованном виде
- `{Array.<FormTuple>} getFields()` - возвращает массив полей
- `{BEM} setVal({Object} val)` - заполняет поля формы новыми значениями, chainable
- ? `{BEMDOM} onSubmit({Function} fn)` - добавляет обработчик на событие отправки формы, chainable (надо унести в `.browser.js`)
- ? `{BEM} useRequest({Request} req)` - выставляет объект Request из которого нужно взять данные (?), chainable (надо унести в `.node.js`). Или убрать вообще и использовать `setVal(req.body).checkValidation()`

##### События

- ? `submit` - зовется при отправке формы


### Элемент `form__tuple` *extends `BEM`*

Интерфейс для примитива поля/контрола формы, служит для абстрагирования формы от полей.

##### Методы экземпляра

- `{String} getName()` - возвращает имя поля. Если имя приходит пустое — в результат `getVal` формы оно не попадает.
- `{*} getVal()` - возвращает значение, может быть чем угодно (см. [form__field])
- `{BEM} setVal({*} val)` - устанавливает значение поля, chainable


### Блок `label`

Блок метки, привязывается к [form__control], [form__field] или [input], [attach], [textarea], etc.


### Элемент `form__control` *extends `form__tuple`*

Заготовка для контрола (?), содержит в себе ровно один элемент ввода (типа [input], [attach], [textarea], etc.)

? Основная его цель — подключать стандартные элементы ввода к форме, чтобы мочь собирать значения, валидировать, ...

Не может использоваться без модификатора type

#### Модификатор `_type_X`

Контрол типа `X`, где `X`, по умолчанию, это один из базовых [input], [attach], [textarea], etc.



## Validation API

### Блок `validation`

Блок для хранения валидаторов, расширяется модификаторами через базовое API.

##### Статические методы
- `{Validation} registerValidator({String} name, {function(this: Validation, {*} val, {?Object} params)} fn)` - регистрируем валидатор
- `{?Boolean} run({String} name, {*} val, {?Object} params)` - проверяем значение `val` с помощью валидатора `name`


### Элемент `validation__dom`

Служит для автоматической проверки значения элемента ввода, расчитан на использование вместе с [input], [attach], [textarea], etc.

? Т.е. к чему угодно, где есть пользовательский ввод — пока не до конца понятно про все инпуты/контролы/аттачи, какой интерфейс должен быть реализован в элементах ввода, и где мы его описываем.

##### Methods

- `{?Boolean} run()` (или `checkValidation()`?) - запускает проверку и выставляет модификатор на `target` блок с результатами проверки

##### Параметры

- `{String} target` - строковое название блока, на который крепится элемент. Блок должен реализовывать некоторый интерфейс, чтобы все работало (?) - нужно его описать

Кроме вышеописанных параметров здесь же можно передать параметры для используемых валидаторов:
```js
{
  js: {target: 'input', numbers: {precision: 3, decimalDelimiter: ','}}
}
```


#### Модификатор `_required`

Регистрирует валидатор `required`, который проверяет на наличие любого ненулевого значения

#### Модификатор `_email`

Регистрирует валидатор `email`, который проверяет на значение на соотв. регулярному выражению `/^.+@.+$/`

#### Модификатор `_numbers`

Регистрирует валидатор `numbers`, который проверяет значение, чтобы оно состояло из цифр и знака разделителя десятичной части

Есть возможно передать точность числа, кол-во десятичных цифр, и т.д. в поле js.

##### Параметры

- `{Number} min` - ограничение снизу числового значения
- `{Number} max` - ограничение сверху числового значения
- `{String} decimalSeparator` - разделитель десятичной части
- `{Number} precision` - ограничение кол-ва цифр в десятичной части

#### Модификатор `_numbers_money`

Наследует функционал `_numbers`, и дополнительно проверяет, что поле конкретно бабло (?)

#### Модификатор `_pattern`

Проверяет, что значение соответствует некоторому выражению.

Требует передачи этого выражения в поле js.

##### Параметры

- `{String} pattern` - регулярное выражение, которому должно соответствовать значение

#### Модификатор `_card`

Регистрирует валидатор `card`, который проверяет значение на длину (16 или 18), на отстутствие нециферных знаков, на прохождение алгоритма `luhn` и на принадлежность номера карты одному из провайдеров (visa, mc, etc.) - ? описать все, которые нам нужны

##### Параметры

- `{String|Array.<String>} cardTypes` - дополнительно проверяет, чтобы карта была выпущена указанным центром


### Модификатор `form_validity` *extends `Form`*

Расширение основного функционала блока формы прохождением валидации при изменении полей и отправке формы.

Зависит от блока [validation].

##### Методы экземпляра
- `{BEM} onSubmit()` - перегрузка сабмита, приостанавливается до положительного разрешения промиса из `checkValidity()`
- `{Promise} checkValidity()` - Таки промис или не промис? Ведь капчу тоже хочется проверять, как же без капчи?

##### Модификатор `_state` *или _vaildation?*

- `form_state_unchecked` - выставляется при инициализации `form_validity`
- `form_state_processing` (`validating`?) — состояние, описывающее процесс затяжной валидации, выставляется после вызова `checkValidity` и стоит до разрешения промиса;
- `form_state_valid` — состояние, когда каждое из полей прошло проверку, либо ни одно из них её не требует;
- `form_state_invalid` — состояние формы, когда есть поля, которые требует проверки, и любое из них её не прошло;


### Блок `message` *extends `BEMDOM`*

Блок сообщения об ошибке, по умолчанию скрыт, но должен рисоваться на сервере, чтобы в последствии его просто показать с нужным текстом ошибки рядом с полем ввода или формой (в случае, например, различных ошибок отправки, потери авторизации, и пр.).

Пивязывается к [form], [form__field], [form__control], в него можно складывать ошибку валидации, прячется если пользователь начал ввод, и вновь отображается при ошибках проверки.

##### Методы экземпляра

- `{BEMDOM} setMessage({String} val)` - выставляет переданную ошибку и отображает блок;
- ? `{BEMDOM} reset()` - удаляет ошибку и прячет блок;
- ? `{String} getMessage()` - возвращает текущую ошибку;
- ? `{String} dropMessage()` - удаляет ошибку, прячет блок и возвращает удаленную ошибку.

#### Модификатор `_visible`

Выставляется при наличии ошибки и намекает браузеру, что пора отобразить блок, и удаляется при её сбросе.


## Fields (draft)

### Блок `form_fielded`

- Натравливает форму на использование `form__field` (`browser.js`);
- Генерирует кишки полей в шаблонах, в т.ч. навешивает валидации;

##### Methods
- `{Array.<FormField>} getFields()`
- `{Object} getVal()`
- `{BEMDOM} setVal({Object} val)`

### Элемент `form__field`

Базовый функционал элемента формы.

Может включать в себя {0..n} контролов, комбинировать их вывод, инициализировать ввод, делать пре/пост процессинг данных из контролов, аггрегировать данные из других полей формы, и т.д. Все решается в контретных реализациях.

#### Модификации form__field_type_X

Поле типа X, которые пользователь определяет и переопределяет на уровнях проекта и бандла.

Позволяет конкретизировать внутреннюю логику поля формы, включая валидацию, возвращаемое значение, и т.д.

##### Примеры

###### _type_price
Cостоит из формы ввода для суммы и селектора валют, в особо тяжелых случаях может еще отображать введенную сумму в рублях при пересчете по курсу ЦБ.
Пример значения: `{currency: 'euro', amount: '152.12'}`.

###### _type_coord
Состоит из 2х скрытых форм ввода (`input type=hidden`) и гео-карты, с помощью которой позволяет выбирать произвольную гео-точку.
Пример значения: `{lat : 55.4507, long : 37.3656}`.

###### _type_nested-leafs
Позволяет выбирать любое кол-во конечных элементов (листьев) в произвольной заранее известной древовидной структуре. Имеет логику отрисовки подветок на клиенте, и т.д.
Пример значения: `[4, 2, 42]`

###### _type_tags
Позволяет выбирать теги из облака.
Пример значения: `['bem', 'rocks']`
